<div class="history-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Order History</h1>
    <div class="header-actions">
      <button mat-stroked-button (click)="openSupportCenter()" class="action-btn">
        <mat-icon>help</mat-icon>
        Support
      </button>

      <button mat-stroked-button [matMenuTriggerFor]="exportMenu" class="action-btn">
        <mat-icon>download</mat-icon>
        Export
      </button>

      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportOrders('csv')">
          <mat-icon>table_chart</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportOrders('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Export as PDF</span>
        </button>
      </mat-menu>

      <mat-form-field appearance="outline" class="search-container search-field">
        <mat-label>Search Orders...</mat-label>
        <input matInput
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchChange()"
              placeholder="Search Orders...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading order history...</p>
    </div>
  } @else {
    <!-- Orders Table -->
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="orders-table">
        <!-- Product Column -->
        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>Product</th>
          <td mat-cell *matCellDef="let order">
            <div class="product-info">
              <div class="product-name">{{ order.product.name }}</div>
              <div class="product-variant">{{ order.product.variant.name }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Order Number Column -->
        <ng-container matColumnDef="orderNumber">
          <th mat-header-cell *matHeaderCellDef>Order Number</th>
          <td mat-cell *matCellDef="let order">
            <span class="order-id">{{ order.id }}</span>
          </td>
        </ng-container>

        <!-- Quantity Column -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let order">{{ order.quantity }}</td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price</th>
          <td mat-cell *matCellDef="let order">
            <span class="amount">{{ formatCurrency(order.totalAmount) }}</span>
          </td>
        </ng-container>

        <!-- Start Date Column -->
        <ng-container matColumnDef="startDate">
          <th mat-header-cell *matHeaderCellDef>Start Date</th>
          <td mat-cell *matCellDef="let order">{{ formatDate(order.createdAt) }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let order">
            <mat-chip
              class="status-chip"
              [style.background-color]="getStatusColor(order.status)">
              {{ order.status | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Receipt Column -->
        <ng-container matColumnDef="receipt">
          <th mat-header-cell *matHeaderCellDef>Receipt</th>
          <td mat-cell *matCellDef="let order">
            @if (order.receiptUrl) {
              <button mat-icon-button (click)="downloadReceipt(order)" matTooltip="View Receipt">
                <mat-icon>receipt</mat-icon>
              </button>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- No results overlay -->
      @if (dataSource.data.length === 0) {
        <div class="no-results-overlay">
          <div class="no-results-content">
            No results.
          </div>
        </div>
      }
    </div>
  }

  <!-- Pagination - Always visible -->
  <div class="pagination-container">
    <mat-paginator
      [pageSizeOptions]="[5, 10, 25, 100]"
      [pageSize]="pageSize()"
      [length]="totalOrders()"
      [pageIndex]="currentPage()"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
